---
title: "DXA : Analyses statistiques"
author: Jérôme Pasquier (Unisanté)
date: 15 février 2021
output:
  pdf_document:
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE}

library(readxl)
library(knitr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stargazer)

opts_chunk$set(echo = FALSE)

# Import data
dxa <- read_xlsx("../data-raw/COOL-OsteoLaus for stat (clean).xlsx",
                 sheet = "COOL data")
dxa <- as.data.frame(dxa)
dxa <- dxa[!(dxa$Id %in% c("Dx00000255", "Dx00001488")), ]
#dxa$`Follow-up DXA Years...16`
#dxa$`Follow-up DXA Years...17`

# Recode variables
for (v in names(dxa)) {
  x <- dxa[[v]]
  if (is.character(x)) {
    x <- trimws(x)
    if (all(is.na(x) | grepl("^[0-9]+((\\.|,)[0-9]+)?$", x))) {
      x <- sub(",", "\\.", x)
      x <- as.numeric(x)
    }
    dxa[[v]] <- x
  }
}
rm(v, x)

```

# Analyses descriptives

## Variables continues

```{r, echo=FALSE}

V <- c("weight_preOp", "Follow-up DXA months", "weight loss kg",
       "Total weight loss (TWL)", "Excès weight loss", "Nadir weight",
       "Time Nadir weight (months)")
do.call(rbind, lapply(V, function(v) {
  x <- na.omit(dxa[[v]])
  data.frame(
    variable = v,
    n = length(x),
    mean = mean(x),
    sd = sd(x),
    median = median(x),
    q25 = quantile(x, 0.25),
    q75 = quantile(x, 0.75),
    min = min(x),
    max = max(x)
  )
})) %>%
  kable(digits = 2, row.names = FALSE)
rm(V)

```

## Variables binaires

```{r, echo=FALSE}

V <- c("T2D-PreOp", "HTA-PreOp", "Dyslipidemia-PreOp", "T2D-PostOp",
       "HTA-PostOp", "Dyslipidemia-PostOp", "TTT_DT2 PostOp",
       "TTT_lipid PostOp")
do.call(rbind, lapply(V, function(v) {
  x <- na.omit(dxa[[v]])
  if (!all(is.na(x) | x %in% 0:1)) stop(paste(v, "not binary"))
  data.frame(
    variable = v,
    n = length(x),
    npos = sum(x),
    `prop (%)` = mean(x) * 100,
    check.names = FALSE
  )
})) %>%
  kable(digits = 2, row.names = FALSE)
rm(V)

```

# Analyses de régression

```{r, echo=FALSE}

rename_matrix <- matrix(byrow = TRUE, ncol = 2, c(
  "DX03_age",                          "Age",
  "DX06_BMI",                          "BMI",
  "Total weight loss (TWL)",           "TWL", 
  "Excès weight loss",                 "EWL",
  "DX58_LeanMassTot%",                 "LeanMassTot",
  "DX62_ALMI (indice de masse maigre appendiculaire ajusté)",
                                       "ALMI",
  "DX55_Tissu adipeux viscéral (VAT)", "VAT",
  "T2D-PreOp",                         "T2DPreOp",
  "HTA-PreOp",                         "HTAPreOp",
  "Dyslipidemia-PreOp",                "DyslipidemiaPreOp",
  "T2D-PostOp",                        "T2DPostOp",
  "HTA-PostOp",                        "HTAPostOp",
  "Dyslipidemia-PostOp",               "DyslipidemiaPostOp"
))
colnames(rename_matrix) <- c("Name in xlsx file", "Name in analyses")
dta <- dxa
for (i in 1:nrow(rename_matrix)) {
  names(dta)[names(dta) == rename_matrix[i, 1]] <- rename_matrix[i, 2]
}
rm(rename_matrix, i)

```

<!-- ====================================================================== -->

## Variable dépendante : `TotalWeightLoss (TWL)`

### Univariable model 1 (`LeanMassTot`)

\begin{center}
```{r, echo=FALSE, results='asis'}
m1 <- lm(TWL ~ LeanMassTot, dta)
m2 <- lm(TWL ~ LeanMassTot + Age + BMI, dta)
stargazer(m1, m2, dep.var.labels=c("Total weight loss"), ci=TRUE,
          ci.level=0.95, single.row=TRUE, float = FALSE, header = FALSE,
          intercept.bottom = FALSE, intercept.top = TRUE,
          model.numbers = FALSE)
```
\end{center}

```{r, message=FALSE, fig.show="hold", out.width="50%"}
ggplot(dta, aes(x = LeanMassTot, y = TWL)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "TotalWeightLoss ~ LeanMassTot")
rbind(
  data.frame(rstd = rstandard(m1), m = 1),
  data.frame(rstd = rstandard(m2), m = 2)
) %>%
  mutate(m = factor(m, 1:2, c("Unadjusted model",  "Adjusted model"))) %>%
  ggplot(aes(sample = rstd)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ m, ncol = 1) +
  labs(title = "Normal Q-Q plot", x = "Theoretical Quantiles",
       y = "Standardized residuals")
rm(m1, m2)
```

### Univariable model 2 (`ALMI`)

\begin{center}
```{r, echo=FALSE, results='asis'}
m1 <- lm(TWL ~ ALMI, dta)
m2 <- lm(TWL ~ ALMI + Age + BMI, dta)
stargazer(m1, m2, dep.var.labels=c("Total weight loss"), ci=TRUE,
          ci.level=0.95, single.row=TRUE, float = FALSE, header = FALSE,
          intercept.bottom = FALSE, intercept.top = TRUE,
          model.numbers = FALSE)
```
\end{center}

```{r, message=FALSE, fig.show="hold", out.width="50%"}
ggplot(dta, aes(x = ALMI, y = TWL)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "TotalWeightLoss ~ ALMI")
rbind(
  data.frame(rstd = rstandard(m1), m = 1),
  data.frame(rstd = rstandard(m2), m = 2)
) %>%
  mutate(m = factor(m, 1:2, c("Unadjusted model",  "Adjusted model"))) %>%
  ggplot(aes(sample = rstd)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ m, ncol = 1) +
  labs(title = "Normal Q-Q plot", x = "Theoretical Quantiles",
       y = "Standardized residuals")
rm(m1, m2)
```

### Multivariable model (`LeanMassTot` + `ALMI`)

\begin{center}
```{r, echo=FALSE, results='asis'}
m1 <- lm(TWL ~ LeanMassTot + ALMI, dta)
m2 <- lm(TWL ~ LeanMassTot + ALMI + Age + BMI, dta)
stargazer(m1, m2, dep.var.labels=c("Total weight loss"), ci=TRUE,
          ci.level=0.95, single.row=TRUE, float = FALSE, header = FALSE,
          intercept.bottom = FALSE, intercept.top = TRUE,
          model.numbers = FALSE)
```
\end{center}

```{r, message=FALSE, fig.show="hold", out.width="50%"}
ggplot(dta, aes(x = LeanMassTot, y = ALMI)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "Correlation between the two independent variables")
rbind(
  data.frame(rstd = rstandard(m1), m = 1),
  data.frame(rstd = rstandard(m2), m = 2)
) %>%
  mutate(m = factor(m, 1:2, c("Unadjusted model",  "Adjusted model"))) %>%
  ggplot(aes(sample = rstd)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ m, ncol = 1) +
  labs(title = "Normal Q-Q plot", x = "Theoretical Quantiles",
       y = "Standardized residuals")
rm(m1, m2)
```

<!-- ====================================================================== -->

## Variable dépendante : `ExcessWeightLoss (EWL)`

### Univariable model 1 (`LeanMassTot`)

\begin{center}
```{r, echo=FALSE, results='asis'}
m1 <- lm(EWL ~ LeanMassTot, dta)
m2 <- lm(EWL ~ LeanMassTot + Age + BMI, dta)
stargazer(m1, m2, dep.var.labels=c("Excess weight loss"), ci=TRUE,
          ci.level=0.95, single.row=TRUE, float = FALSE, header = FALSE,
          intercept.bottom = FALSE, intercept.top = TRUE,
          model.numbers = FALSE)
```
\end{center}

```{r, message=FALSE, fig.show="hold", out.width="50%"}
ggplot(dta, aes(x = LeanMassTot, y = EWL)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "ExcessWeightLoss ~ LeanMassTot")
rbind(
  data.frame(rstd = rstandard(m1), m = 1),
  data.frame(rstd = rstandard(m2), m = 2)
) %>%
  mutate(m = factor(m, 1:2, c("Unadjusted model",  "Adjusted model"))) %>%
  ggplot(aes(sample = rstd)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ m, ncol = 1) +
  labs(title = "Normal Q-Q plot", x = "Theoretical Quantiles",
       y = "Standardized residuals")
rm(m1, m2)
```

### Univariable model 2 (`ALMI`)

\begin{center}
```{r, echo=FALSE, results='asis'}
m1 <- lm(EWL ~ ALMI, dta)
m2 <- lm(EWL ~ ALMI + Age + BMI, dta)
stargazer(m1, m2, dep.var.labels=c("Excess weight loss"), ci=TRUE,
          ci.level=0.95, single.row=TRUE, float = FALSE, header = FALSE,
          intercept.bottom = FALSE, intercept.top = TRUE,
          model.numbers = FALSE)
```
\end{center}

```{r, message=FALSE, fig.show="hold", out.width="50%"}
ggplot(dta, aes(x = ALMI, y = EWL)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "ExcessWeightLoss ~ ALMI")
rbind(
  data.frame(rstd = rstandard(m1), m = 1),
  data.frame(rstd = rstandard(m2), m = 2)
) %>%
  mutate(m = factor(m, 1:2, c("Unadjusted model",  "Adjusted model"))) %>%
  ggplot(aes(sample = rstd)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ m, ncol = 1) +
  labs(title = "Normal Q-Q plot", x = "Theoretical Quantiles",
       y = "Standardized residuals")
rm(m1, m2)
```

### Multivariable model (`LeanMassTot` + `ALMI`)

\begin{center}
```{r, echo=FALSE, results='asis'}
m1 <- lm(EWL ~ LeanMassTot + ALMI, dta)
m2 <- lm(EWL ~ LeanMassTot + ALMI + Age + BMI, dta)
stargazer(m1, m2, dep.var.labels=c("Excess weight loss"), ci=TRUE,
          ci.level=0.95, single.row=TRUE, float = FALSE, header = FALSE,
          intercept.bottom = FALSE, intercept.top = TRUE,
          model.numbers = FALSE)
```
\end{center}

```{r, message=FALSE, fig.show="hold", out.width="50%"}
ggplot(dta, aes(x = LeanMassTot, y = ALMI)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE) +
  labs(title = "Correlation between the two independent variables")
rbind(
  data.frame(rstd = rstandard(m1), m = 1),
  data.frame(rstd = rstandard(m2), m = 2)
) %>%
  mutate(m = factor(m, 1:2, c("Unadjusted model",  "Adjusted model"))) %>%
  ggplot(aes(sample = rstd)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(~ m, ncol = 1) +
  labs(title = "Normal Q-Q plot", x = "Theoretical Quantiles",
       y = "Standardized residuals")
rm(m1, m2)
```

<!-- ====================================================================== -->

# VisceralAdiposeTissue (VAT)

```{r}
X <- c("T2DPreOp", "HTAPreOp", "DyslipidemiaPreOp", "T2DPostOp",
       "HTAPostOp", "DyslipidemiaPostOp")
do.call(rbind, lapply(X, function(x) {
  i0 <- !is.na(dta$VAT) & !is.na(dta[[x]]) & dta[[x]] == 0
  i1 <- !is.na(dta$VAT) & !is.na(dta[[x]]) & dta[[x]] == 1
  u0 <- dta[i0, "VAT"]
  u1 <- dta[i1, "VAT"]
  fml <- as.formula(paste("VAT ~", x))
  data.frame(
    Variable = x,
    N0 = sum(i0),
    Mean0 = mean(u0),
    SD0 = sd(u0),
    N1 = sum(i1),
    Mean1 = mean(u1),
    SD1 = sd(u1),
    ttest.pv = t.test(fml, dta[i0 | i1, ])$p.value,
    wilcox.pv = wilcox.test(fml, dta[i0 | i1, ])$p.value
  )
})) %>%
  kable(digits = 2, row.names = FALSE)
dta[c("VAT", X)] %>%
  gather(variable, value, -VAT) %>%
  mutate(variable = factor(variable, X)) %>%
  ggplot(aes(x = factor(value), y = VAT)) +
  geom_boxplot() +
  facet_wrap(~variable) +
  labs(x = "")
dta[c("VAT", X)] %>%
  gather(variable, value, -VAT) %>%
  mutate(variable = factor(variable, X), value = factor(value)) %>%
  ggplot(aes(x = VAT, group = value, color = value)) +
  stat_ecdf(geom = "step") +
  facet_wrap(~variable) +
  labs(y = "Probability",
       title = "Empirical cumulative distribution functions") +
  theme(legend.title = element_blank())
rm(X)
```
